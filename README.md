# PyInstaller Studio Pro (增强版 v3.1) - 用户手册

欢迎使用 PyInstaller Studio Pro (增强版)！这是一款基于 CustomTkinter 构建的现代化图形界面工具，旨在简化和增强使用 PyInstaller 打包 Python 应用程序的过程。

## 目录

1.  [简介](#1-简介)
2.  [特性概览](#2-特性概览)
3.  [系统要求与首次运行](#3-系统要求与首次运行)
    *   [依赖项](#依赖项)
    *   [首次启动与依赖引导](#首次启动与依赖引导)
4.  [界面概览](#4-界面概览)
    *   [头部区域](#头部区域)
    *   [主内容区 (选项卡)](#主内容区-选项卡)
    *   [底部控制栏](#底部控制栏)
5.  [主要功能与配置项详解](#5-主要功能与配置项详解)
    *   [🎯 基础配置选项卡](#-基础配置选项卡)
        *   [文件与路径配置](#文件与路径配置)
        *   [应用程序详情配置](#应用程序详情配置)
        *   [主要打包选项](#主要打包选项)
    *   [⚙️ 高级设置选项卡](#️-高级设置选项卡)
        *   [模块与依赖项管理](#模块与依赖项管理)
        *   [附加数据文件与资源](#附加数据文件与资源)
        *   [可执行文件优化 (UPX)](#可执行文件优化-upx)
    *   [📱 构建输出选项卡](#-构建输出选项卡)
    *   [🛠️ 工具箱选项卡](#️-工具箱选项卡)
6.  [构建应用程序](#6-构建应用程序)
7.  [配置管理](#7-配置管理)
8.  [快捷键](#8-快捷键)
9.  [日志与故障排除](#9-日志与故障排除)
10. [关于](#10-关于)

---

## 1. 简介

PyInstaller Studio Pro 旨在为 Python 开发者提供一个直观、易用且功能强大的界面，以配置和执行 PyInstaller 打包任务。它利用 CustomTkinter 库打造了美观的现代化用户界面，并集成了多种实用工具来提升打包效率和成功率。

## 2. 特性概览

*   **现代化用户界面**: 基于 CustomTkinter，支持明暗主题切换。
*   **全面的 PyInstaller 选项支持**: 图形化配置大部分 PyInstaller 核心参数。
*   **智能依赖扫描**: 辅助分析项目，查找 PyInstaller 可能遗漏的隐藏导入。
*   **项目根目录**: 方便管理数据文件的相对路径。
*   **数据文件/文件夹管理**: 轻松添加非代码资源到打包结果中。
*   **实时构建反馈**: 显示构建进度条和详细的 PyInstaller 日志输出。
*   **错误提取**: 构建失败时，尝试从日志中高亮显示关键错误信息。
*   **配置管理**: 支持配置的自动保存、加载、另存为及重置。
*   **集成工具箱**: 提供清理构建文件、打开输出目录、复制命令、检查环境等实用功能。
*   **依赖自动引导**: 首次运行时，会检查并提示安装运行本工具所需的核心图形库。
*   **PyInstaller 依赖检查**: 启动时检查系统是否安装 PyInstaller，并提供安装选项。

## 3. 系统要求与首次运行

### 依赖项

*   **Python**: 建议 Python 3.8 或更高版本 (代码中使用了 `pathlib.Path.is_relative_to`，这是 Python 3.9+ 的特性，但有回退逻辑；`sys.stdlib_module_names` 是 Python 3.10+ 的特性，也有回退)。
*   **CustomTkinter**: 用于构建图形界面。
*   **Pillow (PIL)**: CustomTkinter 的依赖，用于图像处理。
*   **PyInstaller**: 核心打包工具。

### 首次启动与依赖引导

*   **图形库引导**: 首次运行 `CNPyInstaller.py` 时，程序会自动检查 `CustomTkinter` 和 `Pillow` 是否已安装。如果未安装，会弹出命令行提示，询问您是否希望立即使用 pip 尝试安装。
    *   选择 `y` (是)，程序将尝试自动安装。安装完成后，程序可能会尝试自动重新启动以应用更改。
    *   选择 `n` (否)，程序将因缺少核心依赖而无法继续。
    *   **注意**: 如果您在没有控制台的环境下运行 (例如直接双击 `pythonw.exe` 执行脚本)，并且缺少这些依赖，程序可能无法正常弹出提示或完成安装。建议首次运行或依赖安装时，从命令行 (如 `cmd.exe` 或 PowerShell) 执行脚本：`python CNPyInstaller.py`。
*   **PyInstaller 检查**: 在图形界面启动前，程序还会检查系统中是否安装了 `PyInstaller`。
    *   如果未安装，同样会在命令行提示您是否安装。
    *   如果选择安装，安装完成后，您需要**手动重新启动 PyInstaller Studio Pro** 以确保新安装的 PyInstaller 被正确识别。
    *   如果在 `pythonw.exe` 环境下运行且未安装 PyInstaller，程序会记录警告，构建功能将不可用，但您仍可使用配置界面。

## 4. 界面概览

PyInstaller Studio Pro 的界面主要分为三个部分：

### 头部区域

*   **标题**: 显示软件名称 "🚀 PyInstaller Studio Pro"。
*   **副标题**: 简要描述软件特性。
*   **状态指示器**: 位于右上角，显示当前系统状态：
    *   🟢 **系统就绪**: 表示一切正常，可以开始配置或构建。此状态下图标会有呼吸灯效果。
    *   🟡 **正在操作...**: 如“正在构建...”、“依赖扫描中...”。
    *   🔴 **错误/失败**: 如“构建失败”、“PyInstaller未找到”。
    *   其他特定状态图标和文字。

### 主内容区 (选项卡)

通过选项卡切换不同的配置和功能区域：

*   **🎯 基础配置**: 设置项目最核心的打包参数。
*   **⚙️ 高级设置**: 进行更细致的打包控制，如模块管理、数据文件、UPX压缩等。
*   **📱 构建输出**: 显示 PyInstaller 构建过程的实时日志和进度。
*   **🛠️ 工具箱**: 提供一系列辅助打包的实用工具。

### 底部控制栏

*   **🚀 开始构建应用程序**: 点击此按钮，根据当前所有配置项开始执行 PyInstaller 打包。
*   **💾 保存**: 将当前所有UI界面的配置快速保存到默认的自动保存路径 (通常在用户主目录下的 `.pyinstaller_studio_pro_v3_1/autosave_config_v3_1.json`)。
*   **🔄 重置**: 将所有配置项恢复到程序的初始默认值。会弹出确认对话框。

## 5. 主要功能与配置项详解

### 🎯 基础配置选项卡

#### 文件与路径配置

*   **🐍 Python 主脚本**:
    *   **必填项**。点击“浏览”按钮选择您的 Python 项目的主入口 `.py` 或 `.pyw` 文件。
    *   选择后，如果“应用程序名称”为空，会自动使用脚本文件名（不含扩展名）填充。
    *   如果“项目根目录”为空，会自动使用脚本所在目录填充。
*   **🌳 项目根目录 (可选)**:
    *   选择您项目的主文件夹。
    *   **重要作用**:
        1.  在“高级设置”中添加数据文件/文件夹时，文件选择对话框将默认从此目录开始浏览。
        2.  添加数据文件/文件夹时，程序会尝试给出相对于此根目录的目标路径建议。
        3.  “工具箱”中的“扫描项目依赖”功能会扫描此目录下的 `.py` 文件。
*   **📂 构建输出目录**:
    *   选择打包结果（最终的可执行文件或文件夹）的存放位置。
    *   对应 PyInstaller 的 `--distpath` 参数。
    *   如果留空，PyInstaller 默认输出到与 `.spec` 文件同级的 `dist` 文件夹中。
    *   **注意**: 当您指定此目录时，PyInstaller Studio Pro 会智能地将 `.spec` 文件和 `build` 临时目录也生成在该输出目录的父级，以保持输出结构整洁。

#### 应用程序详情配置

*   **📝 应用程序名称**:
    *   输入打包后生成的可执行文件（或文件夹，如果是目录模式）的名称。
    *   对应 PyInstaller 的 `--name` 参数。
    *   如果留空，默认为主脚本的文件名。
*   **🎭 应用程序图标**:
    *   点击文件夹图标选择一个图标文件（通常是 `.ico` 文件用于 Windows，`.png` 文件也可以被转换，但 `.icns` 用于 macOS 需要通过其他方式指定或 PyInstaller 自动处理）。
    *   对应 PyInstaller 的 `--icon` 参数。

#### 主要打包选项

这些是常用的开关选项：

*   **🎯 单文件模式 (OneFile)**:
    *   选中: 将所有内容打包成一个单独的可执行文件。启动速度可能稍慢，因为需要先解压到临时目录。对应 `--onefile`。
    *   不选中: 生成一个包含可执行文件和所有依赖项的文件夹。启动速度较快。
    *   默认为选中。
*   **🖼️ 窗口模式 (无控制台)**:
    *   选中: 应用程序运行时不显示命令行控制台窗口（适用于GUI应用）。对应 `--noconsole` (或 `--windowed`)。
    *   不选中: 应用程序运行时会带一个控制台窗口（适用于命令行应用或调试GUI应用）。
*   **🐛 调试模式 (Debug All)**:
    *   选中: 启用 PyInstaller 的详细调试输出，有助于排查打包问题。对应 `--debug=all`。
*   **🧹 清理上次构建缓存**:
    *   选中: 在每次构建开始前，执行 PyInstaller 的清理操作，移除之前的构建缓存和临时文件。对应 `--clean`。
    *   默认为选中，推荐保持，以避免旧缓存导致的问题。

### ⚙️ 高级设置选项卡

#### 模块与依赖项管理

*   **🚫 排除模块 (用英文逗号 ',' 分隔)**:
    *   输入您希望从打包结果中明确排除的Python模块名，多个模块用英文逗号分隔 (例如: `tkinter,matplotlib`)。
    *   用于减小打包体积，或解决特定模块引起的冲突。
    *   对应 PyInstaller 的 `--exclude-module` 参数。
*   **📥 隐藏导入 (用英文逗号 ',' 分隔)**:
    *   **非常重要**。如果您的脚本通过特殊方式（如 `importlib.import_module("模块名")`、字符串执行 `eval("import ...")`、插件机制）动态导入了某些模块，或者 PyInstaller 未能自动检测到某些关键的第三方库（特别是那些包含二进制文件、数据文件或使用了 C 扩展的库），请在此处列出它们的模块名。
    *   多个模块用英文逗号分隔 (例如: `requests,pandas,my_plugin.submodule`)。
    *   **注意**: 对于 Pillow 库，应输入 `PIL` 而不是 `Pillow`。
    *   对应 PyInstaller 的 `--hidden-import` 参数。
    *   可以使用“工具箱”中的“扫描项目依赖”功能来辅助查找可能需要添加到此处的模块。

#### 附加数据文件与资源

用于将非Python代码文件（如图片、JSON配置文件、文本数据、DLLs、其他辅助 `.py` 脚本等）或整个文件夹打包到最终的应用程序中。

*   **列表框**: 显示已添加的数据文件/文件夹的列表，包括源路径和打包后的目标相对路径。
*   **📄 添加文件**:
    1.  点击按钮，会弹出文件选择对话框。如果已设置“项目根目录”，则默认从该目录开始浏览。
    2.  选择一个文件后，会弹出一个对话框，让您输入此文件在打包后的应用程序结构中的**目标相对路径**。
        *   程序可能会根据“项目根目录”给出一个建议路径。
        *   例如，如果源文件是 `project_root/assets/icon.png`，建议的目标路径可能是 `assets/icon.png`。
        *   如果您输入 `.` (英文句点) 或留空，则文件会被直接放在与主可执行文件相同的根目录下，并使用原文件名。
        *   如果您输入 `images/my_icon.png`，则文件会被放在打包后应用内部的 `images` 子目录中，并命名为 `my_icon.png`。
*   **📁 添加文件夹**:
    1.  点击按钮，选择一个文件夹。
    2.  在弹出的对话框中输入此文件夹及其内容在打包后的应用程序内的**目标相对路径**。
        *   例如，源文件夹是 `project_root/data_files`，目标路径输入 `my_app_data`，则 `data_files` 文件夹及其所有内容会被复制到打包后应用内部的 `my_app_data` 文件夹下。
        *   如果目标路径输入 `.`，则源文件夹内的所有内容会被直接合并到应用程序的根目录（不创建父文件夹）。
        *   如果目标路径留空，则源文件夹会以其原名被复制到应用程序的根目录下。
*   **🗑️ 清空列表**: 移除所有已添加的数据文件和文件夹条目。会弹出确认提示。

这些操作对应 PyInstaller 的 `--add-data` 参数。格式为 `源路径<分隔符>目标路径`，分隔符由 `os.pathsep` 决定（Windows上是 `;`，Linux/macOS上是 `:`）。

#### 可执行文件优化 (UPX)

*   **🗜️ 启用 UPX 压缩**:
    *   选中此项以尝试使用 UPX 工具压缩最终生成的可执行文件，可以显著减小文件体积。
    *   前提是您的系统上已经安装了 UPX，并且其路径在系统的 PATH 环境变量中，或者您在下方指定了 UPX 工具目录。
    *   对应 PyInstaller 的 `--upx` 或 `--upx-dir` 参数。
*   **UPX 工具目录 (可选)**:
    *   如果您的 UPX 没有在系统 PATH 中，可以在此点击文件夹图标选择 UPX 可执行文件（`upx.exe` 或 `upx`）所在的目录。
    *   如果留空，PyInstaller 会尝试从系统 PATH 中查找 UPX。

### 📱 构建输出选项卡

此选项卡用于显示 PyInstaller 打包过程的详细信息。

*   **📊 构建进度**:
    *   **进度条**: 粗略显示当前构建阶段的进度。
    *   **状态文本**: 显示当前正在执行的操作的简要描述。
*   **💻 构建日志输出**:
    *   一个只读文本框，实时显示 PyInstaller 执行命令时的所有标准输出和标准错误输出。
    *   包含时间戳、日志级别和消息内容。
    *   如果构建失败，请仔细查看此处的日志以定位问题。程序会尝试高亮显示可能的错误原因。
    *   程序启动信息、工具箱操作日志等也会在这里显示。

### 🛠️ 工具箱选项卡

提供一系列实用工具按钮，鼠标悬停在按钮上会显示功能提示。

*   **🧹 清理构建文件**:
    *   删除 PyInstaller 构建过程中产生的临时文件和目录，如 `build/` 目录、`dist/` 目录 (或您指定的输出目录)、项目根目录下的所有 `.spec` 文件以及所有 `__pycache__` 目录。
    *   有助于在重新构建前确保一个干净的环境。会进行确认。
*   **📁 打开输出目录**:
    *   在系统的文件浏览器中快速打开您配置的“构建输出目录”（如果未配置，则尝试打开默认的 `dist` 目录）。方便您查找打包结果。
*   **📋 复制构建命令**:
    *   将当前界面所有配置生成的完整 PyInstaller 命令行参数复制到系统剪贴板。
    *   方便您在终端手动执行、调试或记录命令。
*   **💾 保存当前配置**:
    *   将当前界面的所有配置参数（包括基础设置、高级设置、数据文件列表等）保存到一个用户选择的 JSON 文件中。这是“另存为”的功能。
*   **📂 加载配置文件**:
    *   从之前保存的 JSON 文件中加载配置参数到当前界面，恢复之前的设置。
*   **🔧 检查依赖环境**:
    *   检查您的 Python 环境，包括：
        *   Python 版本。
        *   PyInstaller 是否安装及其版本。
        *   UPX 是否可用及其版本（如果已配置）。
        *   一些常用的第三方库（如 `requests`, `numpy`, `pandas`, `matplotlib`, `Pillow` 等）是否已安装。
    *   结果会输出到“构建输出”选项卡的日志中，并给出一些关于隐藏导入的建议。
*   **🐍 扫描项目依赖**:
    *   **前提**: 您必须在“基础配置”中设置了有效的“项目根目录”。
    *   此功能会递归扫描您项目根目录下的所有 `.py` 文件，使用 `ast` 模块解析代码，提取 `import` 语句。
    *   然后，它会尝试识别出可能是外部第三方库的依赖项（排除标准库、项目内部模块和已在“隐藏导入”中声明的模块）。
    *   扫描结果会以对话框形式列出，您可以选择希望添加到“隐藏导入”列表中的模块。
    *   这是一个强大的辅助功能，用于补充 PyInstaller 可能遗漏的动态导入或间接依赖。
*   **📝 打开 .spec 文件**:
    *   在系统默认的文本编辑器中打开当前项目生成的 `.spec` 配置文件。
    *   `.spec` 文件通常在第一次成功构建后，与主脚本在同一目录（或您通过 `generate_command` 配置的 `specpath`）生成。文件名通常与“应用程序名称”或主脚本名一致。
    *   方便高级用户直接查看或修改 PyInstaller 的底层配置。
*   **📖 查看官方文档**:
    *   在默认网页浏览器中打开 PyInstaller 官方在线文档 (英文)。
*   **ℹ️ 关于本软件**:
    *   显示本软件的版本信息、主要特性和开发者信息。
*   **🎨 切换界面主题**:
    *   在明亮 (Light) 和深色 (Dark) 两种界面主题之间进行一键切换。

## 6. 构建应用程序

1.  **完成配置**: 在“基础配置”和“高级设置”选项卡中填写所有必要的参数。
    *   **至少需要指定“Python 主脚本”**。
    *   仔细检查“隐藏导入”和“附加数据文件”是否符合您的项目需求。
2.  **点击“🚀 开始构建应用程序”按钮**:
    *   程序会首先执行**预构建检查**：
        *   检查主脚本路径是否有效。
        *   如果添加了包含特定第三方库依赖的辅助 `.py` 脚本作为数据文件（例如，名为 `tools.py` 或 `orchestrator.py` 的文件），并且这些库尚未在“隐藏导入”中声明，程序会弹出一个警告，提示您检查并确认是否需要添加这些隐藏导入。您可以选择继续构建或取消以修改配置。
    *   如果预构建检查通过，程序会切换到“构建输出”选项卡。
    *   构建过程将在后台线程中执行，界面不会卡死。
    *   您可以在“构建输出”选项卡中看到实时的进度条、状态文本和详细的 PyInstaller 日志。
3.  **等待构建完成**:
    *   **构建成功**: 状态指示器会变为绿色，并显示“构建成功”。日志末尾会显示成功信息和输出文件位置。您可以点击“工具箱”中的“打开输出目录”快速找到打包好的应用程序。
    *   **构建失败**: 状态指示器会变为红色，并显示“构建失败”。日志中会包含错误信息。程序会尝试从日志中提取可能的主要错误原因并在弹出的错误消息框中显示。请仔细阅读完整的构建日志以定位问题。

## 7. 配置管理

PyInstaller Studio Pro 支持配置的保存和加载，方便您复用设置。

*   **自动保存**: 当您关闭应用程序时，当前的配置会自动保存到用户主目录下的特定文件 (`~/.pyinstaller_studio_pro_v3_1/autosave_config_v3_1.json`)。
*   **自动加载**: 当您启动应用程序时，会自动尝试从上述路径加载上次保存的配置。如果找不到自动保存的配置文件，则使用默认设置。
*   **手动保存 (底部按钮 💾 保存)**: 点击此按钮，会将当前配置覆盖到默认的自动保存文件。
*   **另存为 (工具箱 💾 保存当前配置)**: 允许您将当前配置保存到您选择的任意位置和文件名的 JSON 文件中。
*   **加载 (工具箱 📂 加载配置文件)**: 允许您从之前通过“另存为”保存的 JSON 文件中加载配置。
*   **重置 (底部按钮 🔄 重置)**: 将所有配置项恢复到程序内置的初始默认值。此操作会弹出确认对话框。

## 8. 快捷键

*   `Ctrl + S`: 另存为配置 (同工具箱中的“保存当前配置”)。
*   `Ctrl + Alt + S`: 快速保存配置到默认路径 (同底部栏的“保存”按钮，并会弹出成功提示)。
*   `Ctrl + O`: 加载配置文件 (同工具箱中的“加载配置文件”)。
*   `Ctrl + Enter`: 如果当前未在构建，则开始构建 (同底部栏的“开始构建应用程序”按钮)。
*   `F1`: 显示“关于本软件”对话框。
*   `F5`: 执行“检查依赖环境”工具。

## 9. 日志与故障排除

*   **GUI 日志**: “构建输出”选项卡是获取打包过程信息和排查问题的主要途径。
*   **文件日志**: 程序运行时，也会将详细的日志（包括调试信息）记录到与 `CNPyInstaller.py` 脚本同目录下的 `pyinstaller_studio_pro_v3_1.log` 文件中。如果遇到难以解决的问题，可以查看此文件获取更底层的技术细节。
*   **常见问题**:
    *   **Hidden import ... not found**: 通常意味着您指定的隐藏导入模块未在 PyInstaller 使用的 Python 环境中安装，或者模块名不正确 (例如 `Pillow` 应为 `PIL`)。请使用“工具箱”中的“检查依赖环境”和“扫描项目依赖”功能进行排查，并在正确的环境中安装缺失的库。
    *   **数据文件找不到**: 确保在“附加数据文件与资源”中指定的源文件路径正确，并且目标路径符合您在代码中访问这些文件的方式。
    *   **UPX 错误**: 如果启用了 UPX 但系统未安装或配置不正确，构建可能会在 UPX 压缩阶段失败。
    *   **特定库的打包问题**: 某些复杂的库 (如 `matplotlib`, `numpy`, `pandas`, `scipy` 等) 可能需要 PyInstaller 的特定 hook 文件才能正确打包。通常 PyInstaller 会自带这些 hook，但版本兼容性问题偶尔会出现。确保这些库和 PyInstaller 都是最新稳定版，或查阅相关库和 PyInstaller 的文档/社区寻求特定解决方案。

## 10. 关于

PyInstaller Studio Pro (增强版 v3.1)
作者：跳舞的火公子

感谢使用！希望这款工具能帮助您更高效地打包Python应用。
